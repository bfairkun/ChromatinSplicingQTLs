configfile: "config/config.yaml"


include: "rules/common.py"
include: "rules/DownloadAndPreprocess.smk"
include: "rules/Alignment.smk"
include: "rules/MakeBigwigs.smk"
# include: "rules/CutAndTagChecks.smk"
include: "rules/QC.smk"
include: "rules/ExpressionAnalysis.smk"
include: "rules/featureCounts.smk"
include: "rules/PeakCalling.smk"
include: "rules/SplicingAnalysis.smk"
include: "rules/ChromatinPehnotypesAnalysis.smk"
include: "rules/ProSeqAnalysis.smk"
include: "rules/QTLTools.smk"
include: "rules/Coloc.smk"
include: "rules/report.smk"
include: "rules/BensJupyterNotebookRules.smk"
include: "rules/NonCodingRNA.smk"
include: "rules/GWAS_PrepForColoc.smk"
include: "rules/IntronSlopes.smk"
include: "rules/ProcessTehranchi.smk"
include: "rules/PlotQTLs.smk"
include: "rules/CalculateExonicPSI.smk"
include: "rules/IntronRetention.smk"
include: "rules/SpliceSiteMutation.smk"
include: "rules/DeNovoNonCodingRNA.smk"
include: "rules/DeNovoNonCodingRNA_plots.smk"
include: "rules/QTL_SNP_Enrichment.smk"
include: "rules/APA_DataPrep.smk"


wildcard_constraints:
    chrom="|".join(autosomes),
    IndID="|".join(Fastq_samples["IndID"]),
    Rep="\d+",
    QTLsGenotypeSet="|".join(["", "HarmonizedSNPs"]),
    FeatureCoordinatesRedefinedFor="|".join(["", "ForColoc", "ForGWASColoc"]),
    Pass="|".join(["PermutationPass", "NominalPass"]),


localrules:
    all,
    CollectNormalizedPsiTables,
    CollectColocResultsToOutputDir,
    CollectDownloadGWAS_SummaryStats,
    Collect_chRNASeq_Fastq,
    CollectColocResultsToCodeDir,
    CopyFastqFromLocal,
    DownloadFastqFromLink,
    Download1KG_GRCh38,
    STAR_make_index,
    DownloadHg38Ref,
    DownloadFastqFromLink_SE,
    DownloadGWAS_SummaryStats,
    InstallHyprcoloc,
    Download_hg19_to_hg38_chain,
    DownloadHg38Gencode_basic,
    DownloadKristjansdottirSupplementData2,
    DownloadChromHMM,


ruleorder: CopyFastqFromLocal > DownloadFastqFromLink


rule all:
    input:
        # expand("logs/PlotGruberQTLs/PlotFromShellScript.{pheno}.log", pheno=["H3K4ME3", "H3K27AC", "H3K4ME1"]),
        ####expand(
        ####    "QC/mbv/plots/{Phenotype}/{IndID}.{Rep}.pdf",
        ####    zip,
        ####    Phenotype=chRNASeqSamples_df["Phenotype"],
        ####    IndID=chRNASeqSamples_df["IndID"],
        ####    Rep=chRNASeqSamples_df["RepNumber"],
        ####),
        #Make bigwigs from test cut and tag
        # "../output/QC/AutosomeCountsPerSamples.tsv",
        # expand("bigwigs_FromNonWASPFilteredReads/{Phenotype}/{IndID}.{Rep}.bw", Phenotype=["POL2S5", "POL2S2", "H3K9ME3", "H3K36ME3", "H3K79ME2"], IndID="NA19210", Rep="1"),
        ####multiext(
        ####    "ReferenceGenome/Annotations/gencode.v34.primary_assembly.annotation.gtf",
        ####    "_all_exons.txt.gz",
        ####    "_all_introns.bed.gz",
        ####    "_fiveprime.bed.gz",
        ####    "_threeprime.bed.gz",
        ####),
        ####expand("SplicingAnalysis/IR/{Phenotype}/Counts.txt", Phenotype=RNASeqPhenotypes),
        ####"SplicingAnalysis/leafcutter/clustering/autosomes/leafcutter_perind.counts.gz",
        # "Multiqc/multiqc_report.html",
        ####expand(
        ####    "QTLs/QTLTools/{Phenotype}/{Pass}.FDR_Added.txt.gz",
        ####    Phenotype=MyPhenotypes,
        ####    Pass=["PermutationPass"],
        ####),
        ####expand(
        ####    "featureCounts/{Phenotype}/NormFactors.tsv",
        ####    Phenotype=[
        ####        "chRNA.Expression.Splicing",
        ####        "Expression.Splicing",
        ####        "H3K4ME1",
        ####        "H3K4ME3",
        ####        "H3K27AC",
        ####        "CTCF",
        ####    ],
        ####),
        ####"ReferenceGenome/Annotations/GTFTools_BasicAnnotations/gencode.v34.chromasomal.tss.bed",
        expand(
            "featureCounts/AtTSS/{Phenotype}/Counts.txt",
            Phenotype=["H3K27AC", "H3K4ME3", "H3K4ME1", "ProCap"],
        ),
        ####expand(
        ####    "featureCounts/{Phenotype}/Counts.txt",
        ####    Phenotype=["MetabolicLabelled.30min", "MetabolicLabelled.60min"],
        ####),
        #expand(
        #   "gwas_summary_stats/full_data/{accession}.tsv.gz", accession=gwas_df.index
        #),
        ####expand(
        ####    "QTLs/QTLTools/{Phenotype}/{Pass}{QTLsGenotypeSet}{FeatureCoordinatesRedefinedFor}.txt.gz",
        ####    Phenotype=PhenotypesToColoc,
        ####    QTLsGenotypeSet=["", "HarmonizedSNPs"],
        ####    FeatureCoordinatesRedefinedFor=["", "ForColoc", "ForGWASColoc"],
        ####    Pass=["NominalPass", "PermutationPass"],
        ####),
        ####"featureCounts/chRNA.Expression.Splicing/CountsExons.txt",
        ####"featureCounts/chRNA.Expression.Splicing/CountTable.MeanLogRPKM.txt.gz",
        expand("QTLs/QTLTools/{Phenotype}/PermutationPass.FDR_Added.txt.gz", Phenotype=MyPhenotypes),
        expand("QTLs/QTLTools/{Phenotype}/PermutationPassForColoc.txt.gz", Phenotype=MyPhenotypes),
        expand("hyprcoloc/Results/ForColoc/{ColocName}/tidy_results_OnlyColocalized.txt.gz", ColocName = colocs_genewise.index),
        expand("QTLs/QTLTools/{Phenotype}/{Pass}{QTLsGenotypeSet}{FeatureCoordinatesRedefinedFor}.txt.tabix.gz", Pass="NominalPass", QTLsGenotypeSet="", FeatureCoordinatesRedefinedFor="ForColoc", Phenotype=MyPhenotypes),
        # expand("hyprcoloc/Results/ForGWASColoc/{ColocName}/results.txt.gz", ColocName = colocs_gwas.index )
        "NonCodingRNA_annotation/annotation/ncRNA.bed.gz",
        'NonCodingRNA_annotation/annotation/ncRNA.histone.tab.gz',
        'NonCodingRNA_annotation/annotation/allGenes.histone.tab.gz',
        'QTLs/QTLTools/chRNA.Slopes/OnlyFirstReps.Slopes.bed.gz',
        'QTLs/QTLTools/chRNA.Slopes/OnlyFirstReps.Intercept.bed.gz',
        expand(
            "QTLs/QTLTools/{Phenotype}.{Prime}/NominalPass.txt.gz",
            Phenotype = ['chRNA.Splicing', 'polyA.Splicing', 'H3K4ME1', 'H3K4ME3', 'H3K27AC', 'H3K36ME3'],
            Prime = ['5PrimeSS', '3PrimeSS']
        ),
        "QTLs/QTLTools/polyA.Splicing.5PrimeSS.Subset_YRI/NominalPass.txt.gz",
        "QTLs/QTLTools/polyA.Splicing.3PrimeSS.Subset_YRI/NominalPass.txt.gz",

rule Collect_chRNASeq_Fastq:
    """
    Useful to force rexecution of all chRNAseq related analysis after
    identifying sample swaps and correcting them in samples.tsv config
    """
    input:
        ####expand(
        ####    "Fastq/{Phenotype}/{IndID}/{Rep}.R1.fastq.gz",
        ####    zip,
        ####    Phenotype=chRNASeqSamples_df["Phenotype"],
        ####    IndID=chRNASeqSamples_df["IndID"],
        ####    Rep=chRNASeqSamples_df["RepNumber"],
        ####),


rule CollectColocResultsToCodeDir:
    """
    invoke this as the target rule to perform colocalizations as defined in config/ColocRunWildcards.tsv without altering any git tracked files in ../output dir
    """
    input:
        expand("hyprcoloc/Results/ForColoc/{ColocName}/tidy_results_OnlyColocalized.txt.gz", ColocName = colocs_genewise.index),
        #expand("hyprcoloc/Results/ForGWASColoc/{ColocName}/results.txt.gz", ColocName = colocs_gwas.index )

rule CollectColocResultsToOutputDir:
    """
    invoke this as the target rule to perform colocalizations as defined in config/ColocRunWildcards.tsv and move them to the ../output dir which is git tracked
    """
    input:
        expand("../output/hyprcoloc_results/ForColoc/{ColocName}/hyprcoloc.results.OnlyColocalized.Stats.txt.gz", ColocName = colocs_genewise.index),
        expand("../output/hyprcoloc_results/ForGWASColoc/{ColocName}/hyprcoloc.results.txt.gz", ColocName = colocs_gwas.index )

rule CollectDownloadGWAS_SummaryStats:
    input:
        expand("gwas_summary_stats/full_data/{accession}.tsv.gz", accession=gwas_df.index)


#### Development rules by Carlos. Some of these might be redundant with all.
        
rule SpliceSiteMutations:
    input:
        expand(
            "QTLs/QTLTools/{Phenotype}.{Prime}/NominalPass.txt.gz",
            Phenotype = ['chRNA.Splicing', 'polyA.Splicing', 'H3K4ME1', 'H3K4ME3', 'H3K27AC', 'H3K36ME3'],
            Prime = ['5PrimeSS', '3PrimeSS']
        ),
        "QTLs/QTLTools/polyA.Splicing.5PrimeSS.Subset_YRI/NominalPass.txt.gz",
        "QTLs/QTLTools/polyA.Splicing.3PrimeSS.Subset_YRI/NominalPass.txt.gz",
        

rule plotNonCodingRNA:
    input:
        expand("NonCodingRNA_annotation/bigwig/{IndID}.plus.bw", 
        IndID = ["NA18486", "NA18497", "NA18498", "NA18499", "NA19201", "NA19210"]),
        expand("NonCodingRNA_annotation/bigwig/{IndID}.minus.bw", 
        IndID = ["NA18486", "NA18497", "NA18498", "NA18499", "NA19201", "NA19210"]),
        expand("NonCodingRNA_annotation/deeptools/matrix/{IndID}.RNA{strictness}.matrix.gz", 
        IndID = ["NA18486", "NA19201", "NA19210"], strictness=["", ".strict1", ".strict2", ".strict3"]),
        expand("NonCodingRNA_annotation/deeptools/plots/{IndID}.RNA{strictness}.plot.png", 
        IndID = ["NA18486", "NA19201", "NA19210"], strictness=["", ".strict1", ".strict2", ".strict3"]),
        expand("NonCodingRNA_annotation/deeptools/matrix/{IndID}.histone{strictness}.matrix.gz", 
        IndID = ["NA19201", "NA19210"], strictness=["", ".strict1", ".strict2", ".strict3"]),
        expand("NonCodingRNA_annotation/deeptools/plots/{IndID}.histone{strictness}.plot.png",  
        IndID = ["NA19201", "NA19210"], strictness=["", ".strict1", ".strict2", ".strict3"]),
        expand("NonCodingRNA_annotation/deeptools/matrix/{IndID}.combined{strictness}.matrix.gz", 
        IndID = ["NA19201", "NA19210"], strictness=["", ".strict1", ".strict2", ".strict3"]),
        expand("NonCodingRNA_annotation/deeptools/plots/{IndID}.combined{strictness}.plot.png",  
        IndID = ["NA19201", "NA19210"], strictness=["", ".strict1", ".strict2", ".strict3"]),
        

  
rule ncRNA_annotation_caller:
    input:
        "NonCodingRNA_annotation/annotation/ncRNA.bed.gz",
        'NonCodingRNA_annotation/annotation/ncRNA.histone.tab.gz',
        'NonCodingRNA_annotation/annotation/allGenes.histone.tab.gz'
        
rule QTLTools_caller:
    input:
        expand(
          "QTLs/QTLTools/chRNA.Expression{RNA_type}/OnlyFirstReps.{data_type}.bed.gz",
          RNA_type = [".Splicing", "_ncRNA"], data_type = ['qqnorm', 'RPKM']
        ),
        expand(
          "QTLs/QTLTools/{Phenotype}/{Pass}.txt.gz",
          Phenotype = ["chRNA.Splicing", "chRNA.Expression.Splicing", "chRNA.Expression_ncRNA",
                       "polyA.Splicing", "Expression.Splicing", "polyA.Expression_ncRNA", 
                       "polyA.Splicing.Subset_YRI", "Expression.Splicing.Subset_YRI", "polyA.Expression_ncRNA.Subset_YRI",
                       "MetabolicLabelled.30min_ncRNA", "MetabolicLabelled.60min_ncRNA",
                       "chRNA.Splicing.Order", "chRNA.IER", "polyA.IER", 
                       "polyA.IER.Subset_YRI", "chRNA.Slopes", "H3K36ME3"],
          Pass = ["PermutationPass.FDR_Added", "NominalPass"]
        ),

